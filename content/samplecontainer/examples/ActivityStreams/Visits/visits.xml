<?xml version="1.0" encoding="UTF-8"?>
<Module>
<ModulePrefs title="Activity Streams">
    <Require feature="opensocial-0.9"/>
    <Require feature="osapi"/>
    <Require feature="dynamic-height"/>
</ModulePrefs>
<Content type="html"><![CDATA[
<style> body {background-color: transparent;} </style>
<link rel="stylesheet" type="text/css" href="libs/jquery.jqplot.min.css" />
<script src="//ajax.googleapis.com/ajax/libs/jquery/1.8.3/jquery.min.js"></script>
<script language="javascript" type="text/javascript" src="libs/jquery.jqplot.min.js"></script>
<script class="include" language="javascript" type="text/javascript" src="libs/jqplot.dateAxisRenderer.min.js"></script>
<script class="include" language="javascript" type="text/javascript" src="libs/jqplot.canvasTextRenderer.min.js"></script>
<script class="include" language="javascript" type="text/javascript" src="libs/jqplot.canvasAxisTickRenderer.min.js"></script>
<script class="include" language="javascript" type="text/javascript" src="libs/jqplot.categoryAxisRenderer.min.js"></script>
<script class="include" language="javascript" type="text/javascript" src="libs/jqplot.barRenderer.min.js"></script>
<script class="include" language="javascript" type="text/javascript" src="libs/jqplot.canvasAxisLabelRenderer.min.js"></script>


<script type="text/javascript">
function onActivitiesLoaded(response){
  var date = new Date;
  var counter_day = [["Sunday", 0],["Monday", 0],["Tuesday", 0],["Wednesday", 0],["Thursday", 0],["Friday", 0],["Saturday", 0]];
  var counter_hour = Array(24);
  for (var i=0; i<counter_hour.length; i++) {
    counter_hour[i] = [(i+1)+"h", 0];
  }

  $.each(response.activities, function(i, activity) {
    if (activity.verb == 'access') {
      date = new Date(activity.published);
      counter_day[date.getDay()][1] += 1;
      counter_hour[date.getHours()][1] += 1;
    }
  });

  var plot1 = $.jqplot('graph_day', [counter_day], {
    title: 'Total number of visits per day',
    series:[{renderer:$.jqplot.BarRenderer}],
    axesDefaults: {
      tickRenderer: $.jqplot.CanvasAxisTickRenderer ,
      tickOptions: {
        fontSize: '10pt'
      }
    },
    axes: {
      xaxis: {
        renderer: $.jqplot.CategoryAxisRenderer,
        label: "Day of the week",
        tickOptions: {
          angle: -30,
        }
      },
      yaxis: {
        label:'Number of visits',
        labelRenderer: $.jqplot.CanvasAxisLabelRenderer
      }
    }
  });

  var plot2 = $.jqplot('graph_hour', [counter_hour], {
    title: 'Total number of visits per hour',
    series:[{renderer:$.jqplot.BarRenderer}],
    axesDefaults: {
      tickRenderer: $.jqplot.CanvasAxisTickRenderer ,
      tickOptions: {
        fontSize: '10pt'
      }
    },
    axes: {
      xaxis: {
        renderer: $.jqplot.CategoryAxisRenderer,
        label: "Hour",
        tickOptions: {
          angle: -30,
        }
      },
      yaxis: {
        label:'Number of visits',
        labelRenderer: $.jqplot.CanvasAxisLabelRenderer
      }
    }
  });

  gadgets.window.adjustHeight();
}

function onContextFound(response){
  loadActivities(response.context.contextId, response.context.contextType);
}

function loadActivities(id, type){
  var batch = osapi.newBatch();
  batch.add('activities', osapi.activitystreams.get({contextId: id, contextType: type}));
  batch.execute(onActivitiesLoaded);
}

function findContext(){
  var batch = osapi.newBatch();
  batch.add('context', osapi.context.get());
  batch.execute(onContextFound);    
}

function init()
{
  findContext(); 
}

gadgets.util.registerOnLoadHandler(init);

</script>
<div id="form">
  <form id="time" action="">
    <label for="time_scale">Time scale :</label>
    <select name="time_scale" id="time_scale">
      <option value="day">Day</option>
      <option value="hour">Hour</option>
    </select>
  </form>
</div>
<div id="graph_day"></div>
<div id="graph_hour"></div>
]]></Content>
</Module>